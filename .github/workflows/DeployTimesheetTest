name: Deploy SSIS Package [TEST]

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest  # Required for SSIS tools
    steps:
    - uses: actions/checkout@v4

    # Install required tools
    - name: Add SSIS to PATH
      run: |
        $ssisPath = "C:\Program Files (x86)\Microsoft SQL Server\150\DTS\Binn"
        echo "$ssisPath" >> $env:GITHUB_PATH

    # Convert ISPAC to hex and deploy via T-SQL (bypasses SSISDeploy.exe issues)
    - name: Deploy using T-SQL
      env:
        SQL_SERVER: ${{ secrets.DEV_SQL_SERVER_URL }}
        SQL_USER: ${{ secrets.DEV_SQL_USER }}
        SQL_PASSWORD: ${{ secrets.DEV_SQL_PASSWORD }}
      run: |
        $ispacPath = "D:\a\AutoExpose\AutoExpose\Timesheet\build\Development\TimesheetMigrationV2.ispac"
        $bytes = [System.IO.File]::ReadAllBytes($ispacPath)
        $hex = [System.BitConverter]::ToString($bytes).Replace("-","")

        $sql = @"
        DECLARE @project_binary VARBINARY(MAX) = 0x$hex
        BEGIN TRY
          IF EXISTS (SELECT 1 FROM [SSISDB].[catalog].[projects] WHERE [name] = 'TimesheetMigrationV2')
            EXEC [SSISDB].[catalog].[delete_project] 'TimesheetMigrationPacks', 'TimesheetMigrationV2'
          
          EXEC [SSISDB].[catalog].[deploy_project] 
            @folder_name = 'TimesheetMigrationPacks',
            @project_name = 'TimesheetMigrationV2',
            @project_stream = @project_binary
          PRINT 'Deployment successful'
        END TRY
        BEGIN CATCH
          PRINT 'ERROR: ' + ERROR_MESSAGE()
          THROW
        END CATCH
        "@

        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USER" -P "$env:SQL_PASSWORD" -d "SSISDB" -Q "$sql"
